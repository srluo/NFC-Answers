<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFC 求解之書 Demo</title>
  <style>
    body {
      font-family:"Microsoft JhengHei",sans-serif;
      color:#333;
      text-align:center;
      padding:2rem;
      background: url("book_bg1.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    header {
      font-size:1.8rem;
      font-weight:bold;
      color:#4a2f00;
      margin-bottom:1rem;
      text-shadow:1px 1px 2px rgba(0,0,0,0.2);
    }
    .result {
      margin-top:2rem;
      padding:1.4rem;
      border-radius:12px;
      background:rgba(255,255,255,0.45);
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      font-size:1.5rem;
      line-height:1.8;
    }
    .notice {
      margin-top:1rem;
      color:#b22222;
      font-weight:bold;
    }
    .info {
      margin-top:0.8rem;
      font-size:0.9rem;
      color:#555;
    }
    button {
      margin-top:1.5rem;
      background:#7b5c2e;
      color:#fff;
      padding:0.6rem 1.2rem;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:0.9rem;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    button:hover { background:#5a4220; }
    .loading { margin-top:2rem; display:none; }
    .spinner {
      margin:0 auto 1rem auto;
      border:6px solid #eee;
      border-top:6px solid #7b5c2e;
      border-radius:50%;
      width:40px; height:40px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }
    .typing { white-space:pre-wrap; text-align:center; }
    .divider { margin:1rem auto; width:200px; }
    #hint { margin-top:1rem; font-size:1rem; color:#333; font-weight:bold; }
  </style>
</head>
<body>
  <header>📖 NFC 求解之書</header>
  <p>感應 NFC 鑰匙圈即可抽出一則答案</p>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>🔮 正在為你抽取今日答案...</p><br>
    <p id="hint">~ 請在心中默念要解答的明確問題 ~ <br>心誠則靈！</p>
  </div>

  <div id="output" class="result" style="display:none;">
    <p style="color:#555;font-size:1.3rem;">✨ 今日答案 ✨</p>
    <p id="ansZh" class="typing"></p>
    <img src="dividing-lines-1.png" class="divider" alt="divider">
    <p id="ansEn" class="typing" style="color:#333;font-size:1.2rem;"></p>
  </div>

  <p id="notice" class="notice" style="display:none;"></p>

  <!-- 📜 收藏此解答 -->
  <button id="saveBtn" onclick="saveResult()" style="display:none;">📜 收藏此解答</button>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    function typeWriter(text, element, speed = 40, callback) {
      let i = 0;
      element.innerText = "";
      (function typing() {
        if (i < text.length) {
          element.innerText += text.charAt(i++);
          setTimeout(typing, speed);
        } else if (callback) callback();
      })();
    }

    async function drawAnswer(uid, tsHex) {
      try {
        // 呼叫後端 API
        const res = await fetch(`/api/answer?uid=${uid}&ts=${tsHex}`);
        const data = await res.json();

        if (data.error) {
          document.getElementById("notice").innerText = data.error;
          document.getElementById("notice").style.display = "block";
          return;
        }

        // 顯示等待轉盤
        document.getElementById("loading").style.display = "block";
        document.getElementById("output").style.display = "none";
        document.getElementById("saveBtn").style.display = "none";

        const delay = 10000 + Math.random() * 2000; // 10~12 秒

        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("hint").style.display = "none";
          document.getElementById("output").style.display = "block";
          typeWriter(data.zh, document.getElementById("ansZh"), 50, () => {
            typeWriter(data.en, document.getElementById("ansEn"), 40, () => {
              document.getElementById("saveBtn").style.display = "inline-block";
            });
          });
        }, delay);

      } catch (err) {
        alert("⚠️ 載入答案失敗，請確認 API 有部署成功！");
      }
    }

    window.addEventListener("load", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("d");

      if (!token) {
        document.getElementById("notice").innerText = "⚠️ 未偵測到 Token，請從 NFC 鑰匙圈感應進入！";
        document.getElementById("notice").style.display = "block";
        return;
      }

      const uid = token.substring(0, 14);
      const tsHex = token.substring(16, 24);
      drawAnswer(uid, tsHex);
    });

    // 📜 保存結果（含日期、流水號、自動命名）
    function saveResult() {
      const output = document.getElementById("output");
      const today = new Date().toISOString().slice(0,10);
      const key = `saveCount_${today}`;
      let count = parseInt(localStorage.getItem(key) || "0") + 1;
      localStorage.setItem(key, count);

      // 包含標題和日期的容器
      const wrapper = document.createElement("div");
      wrapper.style.padding = "10px";
      wrapper.style.background = "#fdf6e3"; // 古卷色
      wrapper.style.textAlign = "center";
      wrapper.innerHTML = `
        <h2 style="margin:0;font-size:1.2rem;">📖 NFC 求解之書</h2>
        <p style="margin:4px 0;font-size:0.9rem;">於 ${today}</p>
        ${output.innerHTML}
      `;

      document.body.appendChild(wrapper);
      html2canvas(wrapper, { backgroundColor: "#fdf6e3" }).then(canvas => {
        const link = document.createElement("a");
        link.download = `answer_${today}_${count}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        document.body.removeChild(wrapper);
      });
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFC ç­”æ¡ˆä¹‹æ›¸ Demo</title>
  <style>
    body {
      font-family:"Microsoft JhengHei",sans-serif;
      color:#333;
      text-align:center;
      padding:2rem;
      background: linear-gradient(#fdf6e3, #f0e1c6);
      background-attachment: fixed;
    }
    /* ç–ŠåŠ ç´™ç´‹ç† */
    body::before {
      content: "";
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: url("https://www.transparenttextures.com/patterns/old-mathematics.png") repeat;
      opacity: 0.3;
      pointer-events: none;
      z-index: -1;
    }
    header {
      font-size:1.8rem;
      font-weight:bold;
      color:#5c432b;
      margin-bottom:1rem;
      text-shadow:1px 1px 2px #e3d9c6;
    }
    .result {
      margin-top:2rem;
      padding:1.5rem;
      border-radius:12px;
      background:rgba(255,255,255,0.85);
      box-shadow:0 2px 10px rgba(0,0,0,0.15);
      font-size:1.2rem;
      line-height:1.8;
    }
    .notice {
      margin-top:1rem;
      color:#993333;
      font-weight:bold;
    }
    .info {
      margin-top:0.8rem;
      font-size:0.9rem;
      color:#444;
    }
    /* Spinner */
    .loading { margin-top:2rem; display:none; }
    .spinner {
      margin:0 auto 1rem auto;
      border:6px solid #f5e6c4;
      border-top:6px solid #8b5e3c;
      border-radius:50%;
      width:40px; height:40px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }
    .typing { white-space:pre-wrap; text-align:center; }
    button {
      margin-top:1.5rem;
      background:#bbb;
      color:#fff;
      padding:0.5rem 1rem;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-size:0.9rem;
    }
    button:hover { background:#999; }
  </style>
</head>
<body>
  <header>ğŸ“– NFC ç­”æ¡ˆä¹‹æ›¸ </header>
  <p>æ„Ÿæ‡‰ NFC é‘°åŒ™åœˆå³å¯æŠ½å‡ºä¸€å‰‡ç­”æ¡ˆ</p>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>ğŸ”® æ­£åœ¨ç‚ºä½ æŠ½å–ä»Šæ—¥ç­”æ¡ˆ...</p>
  </div>

  <div id="output" class="result" style="display:none;">
    <h3>âœ¨ ä»Šæ—¥ç­”æ¡ˆ âœ¨</h3>
    <p id="ansZh" class="typing"></p>
    <p id="ansEn" class="typing" style="color:#555;font-size:1rem;"></p>
    <p id="remaining" class="info"></p>
  </div>

  <p id="notice" class="notice" style="display:none;"></p>
  <button onclick="resetRecord()">ğŸ”„ æ¸¬è©¦ç”¨ï¼šé‡ç½®æŠ½ç±¤ç´€éŒ„</button>

  <script>
    function checkToken(uid, tsHex) {
      const today = new Date().toISOString().slice(0, 10);
      let record = JSON.parse(localStorage.getItem("tokenRecord") || "{}");

      if (record.date !== today) {
        record = { date: today, data: {} };
      }

      const userData = record.data[uid] || { lastTS: null, count: 0, usedAnswers: [] };
      const tsVal = parseInt(tsHex, 16);

      if (userData.lastTS === null) {
        userData.lastTS = tsVal;
        userData.count = 1;
        record.data[uid] = userData;
        localStorage.setItem("tokenRecord", JSON.stringify(record));
        return { ok: true, first: true, userData, record };
      }

      if (tsVal <= userData.lastTS) {
        return { ok: false, error: "âš ï¸ Token ç„¡æ•ˆæˆ–é‡è¤‡ä½¿ç”¨ï¼Œè«‹é‡æ–°æ„Ÿæ‡‰ã€‚" };
      }

      if (userData.count >= 3) {
        return { ok: false, error: "âš ï¸ ä»Šæ—¥æŠ½ç±¤æ¬¡æ•¸å·²é”ä¸Šé™ï¼ˆ3æ¬¡ï¼‰ã€‚" };
      }

      userData.lastTS = tsVal;
      userData.count += 1;
      record.data[uid] = userData;
      localStorage.setItem("tokenRecord", JSON.stringify(record));

      return { ok: true, first: false, userData, record };
    }

    function typeWriter(text, element, speed = 40, callback) {
      let i = 0;
      element.innerText = "";
      (function typing() {
        if (i < text.length) {
          element.innerText += text.charAt(i++);
          setTimeout(typing, speed);
        } else if (callback) {
          callback();
        }
      })();
    }

    // Fisher-Yates æ´—ç‰Œéš¨æ©Ÿé¸
    function pickRandomUnique(data, used) {
      const available = data.filter(d => !used.includes(d.id));
      if (available.length === 0) return data[Math.floor(Math.random() * data.length)];
      const i = Math.floor(Math.random() * available.length);
      return available[i];
    }

    async function drawAnswer(uid, count) {
      try {
        const res = await fetch("book_of_answers_384_full.json");
        const data = await res.json();

        const record = JSON.parse(localStorage.getItem("tokenRecord") || "{}");
        const userData = record.data[uid] || { usedAnswers: [] };

        const pick = pickRandomUnique(data, userData.usedAnswers || []);

        userData.usedAnswers = [...(userData.usedAnswers || []), pick.id];
        record.data[uid] = userData;
        localStorage.setItem("tokenRecord", JSON.stringify(record));

        // é¡¯ç¤ºç­‰å¾…è½‰ç›¤
        document.getElementById("loading").style.display = "block";
        document.getElementById("output").style.display = "none";

        const delay = 1200 + Math.random() * 1500;

        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("output").style.display = "block";
          typeWriter(pick.answer_tw, document.getElementById("ansZh"), 50, () => {
            typeWriter(pick.answer_en, document.getElementById("ansEn"), 40);
          });
          document.getElementById("remaining").innerText = `ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š${3 - count} / 3`;
        }, delay);

      } catch (err) {
        alert("âš ï¸ è¼‰å…¥ç­”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ JSON æª”æ¡ˆè·¯å¾‘ï¼");
      }
    }

    window.addEventListener("load", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("d");

      if (!token) {
        document.getElementById("notice").innerText = "âš ï¸ æœªåµæ¸¬åˆ° Tokenï¼Œè«‹å¾ NFC é‘°åŒ™åœˆæ„Ÿæ‡‰é€²å…¥ï¼";
        document.getElementById("notice").style.display = "block";
        return;
      }

      const uid = token.substring(0, 14);
      const tsHex = token.substring(16, 24);
      const check = checkToken(uid, tsHex);

      if (!check.ok) {
        document.getElementById("notice").innerText = check.error;
        document.getElementById("notice").style.display = "block";
        return;
      }

      drawAnswer(uid, check.userData.count);
    });

    // ğŸ”„ æ¸¬è©¦ç”¨ï¼šä¸ reloadï¼Œç›´æ¥æ¸…ç©º
    function resetRecord() {
      localStorage.removeItem("tokenRecord");
      document.getElementById("notice").innerText = "âœ… æŠ½ç±¤ç´€éŒ„å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°æ„Ÿæ‡‰ã€‚";
      document.getElementById("notice").style.display = "block";
      document.getElementById("output").style.display = "none";
      document.getElementById("loading").style.display = "none";
    }
  </script>
</body>
</html>

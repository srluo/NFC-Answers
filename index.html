<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFC æ±‚è§£ä¹‹æ›¸ Demo</title>
  <style>
    body {
      font-family:"Microsoft JhengHei",sans-serif;
      color:#333;
      text-align:center;
      padding:2rem;
      background: url("book_bg1_A600.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    header {
      font-size:1.8rem;
      font-weight:bold;
      color:#4a2f00;
      margin-bottom:1rem;
      text-shadow:1px 1px 2px rgba(0,0,0,0.2);
    }
    .result {
      margin-top:2rem;
      padding:1.4rem;
      border-radius:12px;
      background:rgba(255,255,255,0.45);
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      font-size:1.5rem;
      line-height:1.8;
    }
    .notice {
      margin-top:1rem;
      color:#b22222;
      font-weight:bold;
    }
    .info {
      margin-top:0.8rem;
      font-size:0.9rem;
      color:#555;
    }
    button {
      margin-top:1rem;
      background:#7b5c2e;
      color:#fff;
      padding:0.6rem 1.2rem;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:0.9rem;
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    button:hover { background:#5a4220; }
    .loading { margin-top:2rem; display:none; }
    .spinner {
      margin:0 auto 1rem auto;
      border:6px solid #eee;
      border-top:6px solid #7b5c2e;
      border-radius:50%;
      width:40px; height:40px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100% { transform:rotate(360deg); }
    }
    .typing { white-space:pre-wrap; text-align:center; }
    .divider { margin:1rem auto; width:200px; }
    #hint { margin-top:1rem; font-size:1rem; color:#333; font-weight:bold; }
  </style>
</head>
<body>
  <header>ğŸ“– NFC æ±‚è§£ä¹‹æ›¸</header>
  <p>æ„Ÿæ‡‰ NFC é‘°åŒ™åœˆå³å¯æŠ½å‡ºä¸€å‰‡ç­”æ¡ˆ</p>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>ğŸ”® æ­£åœ¨ç‚ºä½ æŠ½å–ä»Šæ—¥ç­”æ¡ˆ...</p><br>
    <p id="hint">~ è«‹åœ¨å¿ƒä¸­é»˜å¿µè¦è§£ç­”çš„æ˜ç¢ºå•é¡Œ ~ <br>å¿ƒèª å‰‡éˆï¼</p>
  </div>

  <div id="output" class="result" style="display:none;">
    <p style="color:#555;font-size:1.3rem;">âœ¨ ä»Šæ—¥ç­”æ¡ˆ âœ¨</p>
    <p id="ansZh" class="typing"></p>
    <img src="dividing-lines-1.png" class="divider" alt="divider">
    <p id="ansEn" class="typing" style="color:#333;font-size:1.2rem;"></p>
  </div>

  <p id="remaining" class="info" style="display:none;"></p>
  <p id="notice" class="notice" style="display:none;"></p>

  <button id="saveBtn" onclick="saveResult()" style="display:none;">ğŸ“œ æ”¶è—æ­¤è§£ç­”</button>
  <button id="shareBtn" onclick="shareResult()" style="display:none;">ğŸ“¤ åˆ†äº«</button>
  <button id="resetBtn" onclick="resetRecord()" style="display:none;">ğŸ”„ æ¸¬è©¦ç”¨ï¼šé‡ç½®æŠ½ç±¤ç´€éŒ„</button>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    function checkToken(uid, tsHex) {
      const today = new Date().toISOString().slice(0, 10);
      let record = JSON.parse(localStorage.getItem("tokenRecord") || "{}");
      if (record.date !== today) record = { date: today, data: {} };

      const userData = record.data[uid] || { lastTS: null, count: 0 };
      const tsVal = parseInt(tsHex, 16);

      if (userData.lastTS === null) {
        userData.lastTS = tsVal; userData.count = 1;
        record.data[uid] = userData;
        localStorage.setItem("tokenRecord", JSON.stringify(record));
        return { ok: true, userData };
      }
      if (tsVal <= userData.lastTS) return { ok: false, error: "âš ï¸ Token ç„¡æ•ˆæˆ–é‡è¤‡ä½¿ç”¨ï¼Œè«‹é‡æ–°æ„Ÿæ‡‰ã€‚" };
      if (userData.count >= 3) return { ok: false, error: "âš ï¸ ä»Šæ—¥æŠ½ç±¤æ¬¡æ•¸å·²é”ä¸Šé™ï¼ˆ3æ¬¡ï¼‰ã€‚" };

      userData.lastTS = tsVal; userData.count += 1;
      record.data[uid] = userData;
      localStorage.setItem("tokenRecord", JSON.stringify(record));
      return { ok: true, userData };
    }

    function typeWriter(text, element, speed = 40, callback) {
      let i = 0; element.innerText = "";
      (function typing() {
        if (i < text.length) {
          element.innerText += text.charAt(i++);
          setTimeout(typing, speed);
        } else if (callback) callback();
      })();
    }

    async function drawAnswer(uid, count, tsHex) {
      try {
        const res = await fetch(`/api/getAnswer?uid=${uid}&ts=${tsHex}`);
        const data = await res.json();

        if (!res.ok || !data.success) {
          throw new Error(data.error || "API å›å‚³éŒ¯èª¤");
        }

        const pick = data.answer;

        document.getElementById("loading").style.display = "block";
        document.getElementById("output").style.display = "none";
        const delay = 10000 + Math.random() * 2000;

        setTimeout(() => {
          document.getElementById("loading").style.display = "none";
          document.getElementById("hint").style.display = "none";
          document.getElementById("output").style.display = "block";

          typeWriter(pick.answer_tw, document.getElementById("ansZh"), 50, () => {
            typeWriter(pick.answer_en, document.getElementById("ansEn"), 40);
          });

          document.getElementById("remaining").style.display = "block";
          document.getElementById("remaining").innerText = `ä»Šæ—¥å‰©é¤˜æ¬¡æ•¸ï¼š${data.remaining} / 3`;

          document.getElementById("saveBtn").style.display = "inline-block";
          document.getElementById("shareBtn").style.display = "inline-block";
        }, delay);

      } catch (err) {
        console.error(err);
        alert("âš ï¸ æŠ½å–ç­”æ¡ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
      }
    }

    async function saveResult() { await captureResult(true); }
    async function shareResult() { await captureResult(false, true); }

    async function captureResult(isSave = true, isShare = false) {
      const output = document.getElementById("output");
      if (!output || output.style.display === "none") return;

      const wrapper = document.createElement("div");
      wrapper.style.padding = "10px";
      wrapper.style.background = `url('book_bg1_A600.jpg')`;
      wrapper.style.backgroundSize = "cover";
      wrapper.style.display = "inline-block";
      wrapper.style.textAlign = "center";
      wrapper.style.fontFamily = "Microsoft JhengHei, sans-serif";

      const titleEl = document.createElement("p");
      titleEl.innerText = "ğŸ“– NFC æ±‚è§£ä¹‹æ›¸";
      titleEl.style.fontWeight = "bold";
      titleEl.style.marginBottom = "0.5rem";
      wrapper.appendChild(titleEl);

      const today = new Date().toISOString().slice(0, 10);
      const dateEl = document.createElement("p");
      dateEl.innerText = `æ–¼ ${today}`;
      dateEl.style.marginBottom = "1rem";
      dateEl.style.fontWeight = "bold";
      wrapper.appendChild(dateEl);

      const zh = document.getElementById("ansZh").innerText;
      const zhEl = document.createElement("p");
      zhEl.innerText = zh;
      zhEl.style.fontSize = "1.5rem";
      zhEl.style.margin = "1rem 0";
      wrapper.appendChild(zhEl);

      const divider = document.createElement("img");
      divider.src = "dividing-lines-1.png";
      divider.style.width = "200px";
      divider.style.margin = "0.5rem auto";
      wrapper.appendChild(divider);

      const en = document.getElementById("ansEn").innerText;
      const enEl = document.createElement("p");
      enEl.innerText = en;
      enEl.style.fontSize = "1.2rem";
      enEl.style.color = "#333";
      enEl.style.margin = "1rem 0";
      wrapper.appendChild(enEl);

      document.body.appendChild(wrapper);
      const canvas = await html2canvas(wrapper, { scale: 2 });
      document.body.removeChild(wrapper);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      const todayStr = new Date().toISOString().slice(0, 10);
      let counter = Number(localStorage.getItem("saveCounter_" + todayStr) || 0) + 1;
      localStorage.setItem("saveCounter_" + todayStr, counter);
      const filename = `answer_${todayStr}_${counter}.png`;

      if (isShare && navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], filename, { type: "image/png" })] })) {
        const file = new File([blob], filename, { type: "image/png" });
        await navigator.share({ title: "ğŸ“– NFC æ±‚è§£ä¹‹æ›¸", text: "æˆ‘çš„ä»Šæ—¥è§£ç­”å·²å‡ºçˆï¼", files: [file] });
      } else {
        const link = document.createElement("a");
        link.download = filename;
        link.href = canvas.toDataURL();
        link.click();
      }
    }

    window.addEventListener("load", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("d");
      if (!token) {
        document.getElementById("notice").innerText = "âš ï¸ æœªåµæ¸¬åˆ° Tokenï¼Œè«‹å¾ NFC é‘°åŒ™åœˆæ„Ÿæ‡‰é€²å…¥ï¼";
        document.getElementById("notice").style.display = "block"; return;
      }

      const uid = token.substring(0, 14);
      const tsHex = token.substring(16, 24);
      if (tsHex === "00000000") document.getElementById("resetBtn").style.display = "inline-block";

      const check = checkToken(uid, tsHex);
      if (!check.ok) {
        document.getElementById("notice").innerText = check.error;
        document.getElementById("notice").style.display = "block"; return;
      }

      drawAnswer(uid, check.userData.count, tsHex);
    });

    function resetRecord() {
      localStorage.removeItem("tokenRecord");
      document.getElementById("notice").innerText = "âœ… æŠ½ç±¤ç´€éŒ„å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°æ„Ÿæ‡‰ã€‚";
      document.getElementById("notice").style.display = "block";
      document.getElementById("output").style.display = "none";
      document.getElementById("loading").style.display = "none";
    }
  </script>
</body>
</html>
